# Copyright 2012 Jeffrey Kegler
# This file is part of Marpa::R2.  Marpa::R2 is free software: you can
# redistribute it and/or modify it under the terms of the GNU Lesser
# General Public License as published by the Free Software Foundation,
# either version 3 of the License, or (at your option) any later version.
#
# Marpa::R2 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser
# General Public License along with Marpa::R2.  If not, see
# http://www.gnu.org/licenses/.

use 5.010;
use strict;
use warnings;
use Fatal qw(open close chdir chmod utime unlink);

# Portability is NOT emphasized here -- this script is part
# of the development environment, not the configuration or
# installation environment

for my $file (qw(Build.PL MANIFEST))
{
   -e $file or die "No $file: wrong directory?";
}

for my $subdir (qw(lib libmarpa t lib inc))
{
   -d $subdir or die "No $subdir/: wrong directory?";
}
chdir 'libmarpa/dev';
system('make', 'install') == 0 or die('Cannot make install in libmarpa/dev');
chdir '../../libmarpa/stage';
system('make', 'dist') == 0 or die('Cannot make dist in libmarpa/stage');
my $version_info = `./configure --version`;
my ($version) = $version_info =~ m/\A marpa \s configure \s ([\d.]*)$/msx;

chdir '..'; # PWD=libmarpa
if (-d 'build') {
    system('rm', '-rf', 'build') and die "rm -rf libmarpa/build failed: $!";
}
my $tar_file = 'stage/marpa-' . $version . '.tar.gz';
my $untarred_dir = 'marpa-' . $version;
say "Tar file is $tar_file";
system('tar', '-xzf', $tar_file) == 0 or die("Could not tar -xvzf $tar_file: $!");
rename $untarred_dir, 'build' or die "rename failed: $!";

chdir 'build'; # PWD=libmarpa/build
unlink 'texinfo.tex';

